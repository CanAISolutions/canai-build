name: CanAI Security Scanning & Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security scans daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

# TODO: All security jobs are currently disabled for MVP focus. Re-enable before major release or after MVP stabilization.

env:
  NODE_VERSION: '18'
  FORCE_COLOR: 1

jobs:
  semgrep:
    name: Semgrep Static Analysis (SAST)
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep:latest
    steps:
      - uses: actions/checkout@v4
      - name: Semgrep Scan
        run: |
          semgrep ci \
            --config "p/typescript" \
            --config "p/nodejs" \
            --config "p/owasp-top-ten" \
            --output semgrep-results.json \
            --json
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      - name: Process Semgrep Results
        run: |
          node scripts/process-semgrep-results.js

  npm_audit:
    name: Dependency Security Audit (npm audit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Run npm audit
        run: |
          npm audit --json > audit-results.json || true
      - name: Process Audit Results
        run: |
          node scripts/process-audit-results.js

  zap_scan:
    name: OWASP ZAP API Scan (DAST)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging' || github.event_name == 'schedule'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: ZAP API Scan
        uses: zaproxy/action-api-scan@v0.5.0
        with:
          target: 'https://api.staging.yourapp.com' # TODO: Set to your staging API endpoint
          format: 'json'
          cmd_options: '-c config.yaml' # TODO: Provide config.yaml if needed
          allow_issue_writing: true
          fail_action: false
      - name: Process ZAP Results
        run: |
          node scripts/process-zap-results.js

permissions:
  security-events: write
  actions: read
  contents: read
